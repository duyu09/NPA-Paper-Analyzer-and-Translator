<!-- Copyright Â© 2025~2026 DuYu (qluduyu09@163.com; 11250717@stu.lzjtu.edu.cn), Lanzhou Jiaotong University -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â€œæ ¸åŠ¨åŠ›â€â€”â€”PDFåŠMarkdownè®ºæ–‡è§£æ&ç¿»è¯‘å™¨ (@duyu09 - 11250717@stu.lzjtu.edu.cn)</title>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="./js/marked.min.js"></script>
    <script src="./js/tex-mml-chtml.js"></script>
    <script src="./js/t-loading.js"></script>
    <style>
        :root {
            --border-color: #d0d7de;
            --header-bg: #f6f8fa;
            --header-height: 32px;
            --control-height: 60px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #fff;
        }

        /* å¸ƒå±€ */
        .main-container {
            flex: 1;
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
            padding: 12px;
            min-height: 0;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            min-height: 0;
        }

        /* åŒºå— */
        .block {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            background: white;
            min-width: 0;
            min-height: 0;
            overflow: hidden;
        }

        .block-header {
            height: var(--header-height);
            background: var(--header-bg);
            padding: 0 10px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            /* åŠ æ·±é¢œè‰² */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            user-select: none;
            --webkit-user-select: none;
        }

        /* æ–‡æœ¬åŒºåŸŸ - ä»£ç å­—ä½“ä¿æŒ Consolas */
        textarea {
            flex: 1;
            padding: 12px;
            border: none;
            resize: none;
            outline: none;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            overflow-y: auto;
            min-height: 0;
        }

        textarea:read-only {
            background-color: #f6f8fa;
            color: #666;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .preview {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            min-height: 0;
            font-family: "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            font-size: 14px;
            line-height: 1.6;
            color: #24292f;
            word-wrap: break-word;
            scroll-behavior: smooth;
        }

        /* é¢„è§ˆç»†èŠ‚ */
        .preview h1,
        .preview h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
            margin-top: 10px;
        }

        .preview pre {
            background: #f6f8fa;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 10px;
        }

        .preview code {
            font-family: Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 85%;
            background-color: rgba(175, 184, 193, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 6px;
        }

        .preview pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .preview img {
            max-width: 100%;
        }

        .preview blockquote {
            border-left: 4px solid #d0d7de;
            margin: 0;
            padding-left: 10px;
            color: #666;
        }

        /* åº•éƒ¨æ§åˆ¶åŒº */
        .controls {
            height: var(--control-height);
            background: #f6f8fa;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 12px;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select,
        input {
            padding: 5px 8px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 13px;
            height: 32px;
            background: white;
            font-family: inherit;
        }

        input:disabled,
        select:disabled {
            background-color: #f6f8fa;
            color: #57606a;
        }

        button {
            height: 32px;
            padding: 0 16px;
            border: 1px solid rgba(27, 31, 36, 0.15);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-family: inherit;
        }

        button:disabled {
            background-color: #f6f8fa;
            color: #8c959f;
            cursor: not-allowed;
            border-color: #d0d7de;
        }

        .btn-primary {
            background-color: #2da44e;
            color: #fff;
            border-color: rgba(27, 31, 36, 0.15);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2c974b;
        }

        .btn-danger {
            background-color: #cf222e;
            color: #fff;
            border-color: rgba(27, 31, 36, 0.15);
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #a40e26;
        }

        .btn-secondary {
            background-color: #f6f8fa;
            color: #24292f;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #f3f4f6;
        }

        .icon-btn {
            font-size: 12px;
            padding: 2px 8px;
            height: 24px;
            line-height: 20px;
            background: #fff;
            border: 1px solid #d0d7de;
        }

        .icon-btn:hover {
            background-color: #f3f4f6;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d0d7de;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #afb8c1;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        /* =========================================
   é’ˆå¯¹ #inputPreview å’Œ #outputPreview çš„è¡¨æ ¼æ ·å¼
   ä¿®æ­£ç‰ˆï¼šä¸¥æ ¼é™åˆ¶å®½åº¦ï¼Œä»…åœ¨é«˜åº¦ä¸Šè‡ªé€‚åº”
   ========================================= */

        /* 1. åŸºç¡€è¡¨æ ¼å®¹å™¨è®¾ç½® */
        /* ä½¿ç”¨ç©ºæ ¼é€‰æ‹©å™¨ï¼Œé€‰ä¸­æ‰€æœ‰æ·±å±‚åµŒå¥—çš„è¡¨æ ¼ */
        #inputPreview table,
        #print-container>table table,
        #outputPreview table {
            width: 100%;
            /* æ ¸å¿ƒä¿®æ­£ï¼šæœ€å¤§å®½åº¦é™åˆ¶ï¼Œé˜²æ­¢æº¢å‡º */
            max-width: 100%;
            border-collapse: collapse;
            margin: 20px 0;

            /* ç»´æŒåŸè¦æ±‚çš„å­—ä½“è®¾ç½® */
            font-size: 15px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #333;

            /* æ ¸å¿ƒä¿®æ­£ï¼šé»˜è®¤å¸ƒå±€ç®—æ³•ï¼Œé…åˆ max-width èƒ½å¤Ÿè‡ªé€‚åº” */
            table-layout: auto;
        }

        /* 2. è¡¨å¤´æ ·å¼ */
        #inputPreview table thead tr,
        #print-container>table table thead tr,
        #outputPreview table thead tr {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            text-align: left;
        }

        #inputPreview table th,
        #print-container>table table th,
        #outputPreview table th {
            /* è°ƒæ•´ï¼šå‡å°‘å·¦å³ padding (8px)ï¼Œé˜²æ­¢åˆ—å¤šæ—¶æŒ¤å‹å†…å®¹ï¼›ä¿æŒä¸Šä¸‹ padding (12px) ç»´æŒé«˜åº¦ç¾æ„Ÿ */
            padding: 12px 8px;
            font-weight: 600;
            white-space: normal;

            /* å‚ç›´å±…ä¸­ */
            vertical-align: middle;
        }

        /* 3. è¡¨æ ¼å†…å®¹å•å…ƒæ ¼ */
        #inputPreview table td,
        #print-container>table table td,
        #outputPreview table td {
            /* ä¿æŒä¸ th ä¸€è‡´çš„ padding */
            padding: 12px 8px;
            border-bottom: 1px solid #ebedf0;

            /* å‚ç›´å±…ä¸­ï¼Œç¡®ä¿æ¢è¡Œåå†…å®¹ä¾ç„¶å±…ä¸­å¯¹é½ï¼Œè§†è§‰æ•´é½ */
            vertical-align: middle;

            /* å…è®¸é•¿å•è¯å¼ºè¡ŒæŠ˜è¡Œï¼Œé˜²æ­¢æ’‘å¼€è¡¨æ ¼ */
            word-break: break-word;
            /* å¢åŠ è¡Œé«˜ï¼Œä¼˜åŒ–å¤šè¡Œæ–‡æœ¬çš„é˜…è¯»ä½“éªŒï¼ˆé«˜åº¦å±‚é¢çš„ä¼˜åŒ–ï¼‰ */
            line-height: 1.5;
        }

        /* 4. äº¤äº’æ•ˆæœ */
        #inputPreview table tbody tr:hover,
        #outputPreview table tbody tr:hover {
            background-color: #f1f3f5;
            transition: background-color 0.2s ease;
        }

        /* 5. æ•°å­—åˆ—ä¼˜åŒ– */
        #inputPreview table td.numeric,
        #inputPreview table th.numeric,
        #print-container>table table td.numeric,
        #print-container>table table th.numeric,
        #outputPreview table td.numeric,
        #outputPreview table th.numeric {
            text-align: right;
            font-feature-settings: "tnum";
        }
    </style>
</head>

<body>

    <div class="main-container">
        <div class="row">
            <div class="block">
                <div class="block-header">
                    <span>1. åŸæ–‡è¾“å…¥</span>
                    <button id="btnImport" class="icon-btn" onclick="importFile()">ğŸ“‚ å¯¼å…¥ (PDF æˆ– Markdown æ–‡ä»¶)</button>
                </div>
                <textarea id="inputText" placeholder="# åœ¨æ­¤è¾“å…¥ Markdown..." oninput="render('input')"></textarea>
            </div>
            <div class="block">
                <div class="block-header">2. åŸæ–‡é¢„è§ˆ</div>
                <div id="inputPreview" class="preview"></div>
            </div>
        </div>

        <div class="row">
            <div class="block">
                <div class="block-header">3. è¯‘æ–‡è¾“å‡º</div>
                <textarea id="outputText" placeholder="> ç¿»è¯‘ç»“æœå°†åœ¨æ­¤ç”Ÿæˆ..." oninput="render('output')"></textarea>
            </div>
            <div class="block">
                <div class="block-header">4. è¯‘æ–‡é¢„è§ˆ</div>
                <div id="outputPreview" class="preview"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="group">
            <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥GLM API Key" style="width: 135px;">
            <input type="password" id="MinerU-apiKey" placeholder="è¯·è¾“å…¥MinerU API Key" style="width: 135px;">
            <select id="modelSelect" onchange="checkCustomModel()">
                <option value="GLM-4.5-Flash">GLM-4.5-Flash</option>
                <option value="GLM-4.6V-Flash">GLM-4.6V-Flash</option>
                <option value="GLM-4.1V-Thinking-Flash">Thinking-Flash</option>
                <option value="GLM-4-Flash-250414">Flash-250414</option>
                <option value="GLM-4V-Flash">GLM-4V-Flash</option>
                <option value="å…¶å®ƒ">å…¶å®ƒ</option>
            </select>
            <input type="text" id="customModel" placeholder="æ¨¡å‹å" style="width: 120px; display: none;">
        </div>

        <div class="group">
            <select id="sourceLang" style="width: 150px;">
                <option>è‹±è¯­(English)</option>
                <option>ç®€ä½“ä¸­æ–‡(ç®€ä½“ä¸­æ–‡)</option>
                <option>ç¹ä½“ä¸­æ–‡(ç¹é«”ä¸­æ–‡)</option>
                <option>æ—¥æœ¬è¯­(æ—¥æœ¬èª)</option>
                <option>æœé²œè¯­(ì¡°ì„ ì–´)</option>
                <option>è¶Šå—è¯­(Tiáº¿ng Viá»‡t)</option>
                <option>æ³°è¯­(à¸ à¸²à¸©à¸²à¹„à¸—à¸¢)</option>
                <option>é«˜æ£‰è¯­(ááŸ’á˜áŸ‚áš)</option>
                <option>é©¬æ¥è¯­(Bahasa Melayu)</option>
                <option>ä¼ ç»Ÿè’™å¤è¯­(á ®á £á ©á ­á £á ¯ á ¬á ¡á ¯á ¡)</option>
                <option>è—è¯­(à½–à½¼à½‘à¼‹à½¦à¾à½‘à¼)</option>
                <option>ä¿„è¯­(Ğ ÑƒÑÑĞºĞ¸Ğ¹)</option>
                <option>ä¹Œå…‹å…°è¯­(Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)</option>
                <option>æ³•è¯­(FranÃ§ais)</option>
                <option>å¾·è¯­(Deutsch)</option>
                <option>è¥¿ç­ç‰™è¯­(EspaÃ±ol)</option>
                <option>æ„å¤§åˆ©è¯­(Italiano)</option>
                <option>è‘¡è„ç‰™è¯­(PortuguÃªs)</option>
                <option>è·å…°è¯­(Nederlands)</option>
                <option>ç‘å…¸è¯­(Svenska)</option>
                <option>åœŸè€³å…¶è¯­(TÃ¼rkÃ§e)</option>
                <option>å¸Œè…Šè¯­(Î•Î»Î»Î·Î½Î¹ÎºÎ¬)</option>
                <option>çŠ¹å¤ªè¯­(×¢×‘×¨×™×ª)</option>
                <option>é˜¿æ‹‰ä¼¯è¯­(Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
                <option>å°åœ°è¯­(à¤¹à¤¿à¤¨à¥à¤¦à¥€)</option>
                <option>æ³°ç±³å°”è¯­(à®¤à®®à®¿à®´à¯)</option>
                <option>ä¹Œå°”éƒ½è¯­(Ø§ÙØ±Ø¯ÙÙˆ)</option>
            </select>
            <span style="color: #666; font-size: 12px;">â¡</span>
            <select id="targetLang" style="width: 150px;">
                <option>ç®€ä½“ä¸­æ–‡(ç®€ä½“ä¸­æ–‡)</option>
                <option>ç¹ä½“ä¸­æ–‡(ç¹é«”ä¸­æ–‡)</option>
                <option>è‹±è¯­(English)</option>
                <option>æ—¥æœ¬è¯­(æ—¥æœ¬èª)</option>
                <option>æœé²œè¯­(ì¡°ì„ ì–´)</option>
                <option>è¶Šå—è¯­(Tiáº¿ng Viá»‡t)</option>
                <option>æ³°è¯­(à¸ à¸²à¸©à¸²à¹„à¸—à¸¢)</option>
                <option>é«˜æ£‰è¯­(ááŸ’á˜áŸ‚áš)</option>
                <option>é©¬æ¥è¯­(Bahasa Melayu)</option>
                <option>ä¼ ç»Ÿè’™å¤è¯­(á ®á £á ©á ­á £á ¯ á ¬á ¡á ¯á ¡)</option>
                <option>è—è¯­(à½–à½¼à½‘à¼‹à½¦à¾à½‘à¼)</option>
                <option>ä¿„è¯­(Ğ ÑƒÑÑĞºĞ¸Ğ¹)</option>
                <option>ä¹Œå…‹å…°è¯­(Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)</option>
                <option>æ³•è¯­(FranÃ§ais)</option>
                <option>å¾·è¯­(Deutsch)</option>
                <option>è¥¿ç­ç‰™è¯­(EspaÃ±ol)</option>
                <option>æ„å¤§åˆ©è¯­(Italiano)</option>
                <option>è‘¡è„ç‰™è¯­(PortuguÃªs)</option>
                <option>è·å…°è¯­(Nederlands)</option>
                <option>ç‘å…¸è¯­(Svenska)</option>
                <option>åœŸè€³å…¶è¯­(TÃ¼rkÃ§e)</option>
                <option>å¸Œè…Šè¯­(Î•Î»Î»Î·Î½Î¹ÎºÎ¬)</option>
                <option>çŠ¹å¤ªè¯­(×¢×‘×¨×™×ª)</option>
                <option>é˜¿æ‹‰ä¼¯è¯­(Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
                <option>å°åœ°è¯­(à¤¹à¤¿à¤¨à¥à¤¦à¥€)</option>
                <option>æ³°ç±³å°”è¯­(à®¤à®®à®¿à®´à¯)</option>
                <option>ä¹Œå°”éƒ½è¯­(Ø§ÙØ±Ø¯ÙÙˆ)</option>
            </select>
        </div>

        <div class="group">
            <button class="btn-secondary" id="btnExport" onclick="exportFile()">å¯¼å‡º MD</button>
            <button class="btn-secondary" id="btnExportPdf" onclick="exportToPdf()">å¯¼å‡º PDF</button>
            <button class="btn-primary" id="btnStart" onclick="toggleTranslation()">å¼€å§‹ç¿»è¯‘</button>
        </div>
    </div>
    <script>
        function exportToPdf() {
            var element = document.getElementById('outputPreview');
            if (!element) {
                alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ° ID ä¸º outputPreview çš„å…ƒç´ ");
                return;
            }

            // 1. åˆ›å»ºæ‰“å°ä¸“ç”¨å®¹å™¨ï¼ˆè¦†ç›–åœ¨é¡µé¢æœ€ä¸Šå±‚ï¼‰
            var printContainer = document.createElement('div');
            printContainer.id = 'print-container';

            // 2. æ„å»ºâ€œè¡¨æ ¼å«ç‰‡â€ç»“æ„
            // è¿™ç§ç»“æ„åˆ©ç”¨äº† thead åœ¨æ¯ä¸€é¡µé‡å¤çš„ç‰¹æ€§æ¥æ¨¡æ‹Ÿ Margin-Top
            // åˆ©ç”¨ tfoot åœ¨æ¯ä¸€é¡µé‡å¤çš„ç‰¹æ€§æ¥æ¨¡æ‹Ÿ Margin-Bottom
            // ä¾§è¾¹è·é€šè¿‡ td çš„ padding æ¥å®ç°
            var htmlContent = element.innerHTML;

            printContainer.innerHTML = `
        <table>
            <thead>
                <tr>
                    <td>
                        <div style="height: 20mm; overflow: hidden;">&nbsp;</div>
                    </td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 0 20mm;"> <div id="print-content-clone">
                            ${htmlContent}
                        </div>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td>
                        <div style="height: 20mm; overflow: hidden;">&nbsp;</div>
                    </td>
                </tr>
            </tfoot>
        </table>
    `;

            document.body.appendChild(printContainer);

            // 3. æ³¨å…¥æ‰“å°ä¸“ç”¨æ ·å¼
            var printStyle = document.createElement('style');
            printStyle.innerHTML = `
        @media print {
            /* å…³é”®ï¼šå¼ºåˆ¶å»é™¤æµè§ˆå™¨é»˜è®¤é¡µçœ‰é¡µè„š */
            @page {
                size: auto;
                margin: 0mm; 
            }

            /* éšè—åŸç½‘é¡µæ‰€æœ‰å†…å®¹ */
            body > *:not(#print-container) {
                display: none !important;
            }

            /* æ˜¾ç¤ºæˆ‘ä»¬çš„æ‰“å°å®¹å™¨ */
            #print-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                background: white;
                z-index: 99999;
            }
            
            /* è¡¨æ ¼æ ·å¼é‡ç½®ï¼Œç¡®ä¿å®½åº¦å æ»¡ */
            #print-container table {
                width: 100%;
                border-collapse: collapse;
            }
            
            /* ä¿è¯å›¾ç‰‡å’Œ SVG ä¸è¢«åˆ‡æ–­ */
            img, svg {
                break-inside: avoid;
                max-width: 100%;
            }
            
            /* ä½ çš„è‡ªå®šä¹‰å†…å®¹æ ·å¼å¯ä»¥è¿½åŠ åœ¨è¿™é‡Œ... */
        }
        
        /* åœ¨å±å¹•ä¸Šéšè—è¿™ä¸ªå®¹å™¨ï¼Œåªåœ¨æ‰“å°æ—¶ç”¨ */
        @media screen {
            #print-container {
                display: none;
            }
        }
    `;
            document.head.appendChild(printStyle);

            // 4. æ‰§è¡Œæ‰“å°
            // ç¨å¾®å»¶æ—¶ä»¥ç¡®ä¿ DOM æ¸²æŸ“å®Œæˆï¼ˆç‰¹åˆ«æ˜¯å›¾ç‰‡ï¼‰
            setTimeout(function () {
                window.print();

                // 5. æ‰“å°å®Œæˆåæ¸…ç†ç°åœºï¼ˆå¯é€‰ï¼‰
                // ä¸ºäº†ä½“éªŒå¥½ï¼Œé€šå¸¸å»ºè®®å»¶è¿Ÿæ¸…ç†ï¼Œå› ä¸ºæ‰“å°å¯¹è¯æ¡†å¼¹å‡ºæ—¶ JS å¯èƒ½ä¼šæŒ‚èµ·
                // å¦‚æœæƒ³ä¿ç•™å¤šæ¬¡æ‰“å°èƒ½åŠ›ï¼Œä¹Ÿå¯ä»¥ä¸åˆ ï¼Œä¸‹æ¬¡ç”Ÿæˆå‰æ£€æŸ¥ä¸€ä¸‹ ID æ˜¯å¦å­˜åœ¨
                setTimeout(function () {
                    document.body.removeChild(printContainer);
                    document.head.removeChild(printStyle);
                }, 2000);
            }, 100);
        }
    </script>

    <script>
        // --- æ•°å­¦å…¬å¼ä¿æŠ¤é€»è¾‘ ---
        // è§£å†³ marked.js è¯¯å°† LaTeX ä¸‹åˆ’çº¿è§£æä¸ºæ–œä½“çš„é—®é¢˜
        const mathPlaceholders = [];

        function protectMath(text) {
            mathPlaceholders.length = 0; // æ¸…ç©ºæ•°ç»„
            // 1. ä¿æŠ¤å—çº§å…¬å¼ $$...$$
            text = text.replace(/\$\$([\s\S]*?)\$\$/g, function (match) {
                mathPlaceholders.push(match);
                return "%%%MATH_BLOCK_" + (mathPlaceholders.length - 1) + "%%%";
            });
            // 2. ä¿æŠ¤è¡Œå†…å…¬å¼ $...$
            text = text.replace(/\$([^\n]*?)\$/g, function (match) {
                mathPlaceholders.push(match);
                return "%%%MATH_INLINE_" + (mathPlaceholders.length - 1) + "%%%";
            });
            return text;
        }

        function restoreMath(text) {
            // è¿˜åŸå…¬å¼ï¼Œè®© MathJax æ¸²æŸ“
            return text.replace(/%%%MATH_(BLOCK|INLINE)_(\d+)%%%/g, function (match, type, index) {
                return mathPlaceholders[index];
            });
        }

        // --- æ¸²æŸ“æ ¸å¿ƒ ---
        let renderTimer;

        function render(type) {
            clearTimeout(renderTimer);
            renderTimer = setTimeout(() => {
                const textId = type === 'input' ? 'inputText' : 'outputText';
                const previewId = type === 'input' ? 'inputPreview' : 'outputPreview';
                const text = document.getElementById(textId).value;
                const preview = document.getElementById(previewId);

                // 1. ä¿æŠ¤å…¬å¼ä¸è¢« Markdown è§£æ
                const protectedText = protectMath(text);

                // 2. è§£æ Markdown
                const html = marked.parse(protectedText);

                // 3. è¿˜åŸå…¬å¼
                preview.innerHTML = restoreMath(html);

                // 4. ç«‹å³æ»šåŠ¨
                if (type === 'output') scrollToBottom(preview);

                // 5. MathJax æ¸²æŸ“
                MathJax.typesetPromise([preview]).then(() => {
                    if (type === 'output') scrollToBottom(preview);
                }).catch(err => console.log(err));
            }, 10);
        }

        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        function checkCustomModel() {
            const val = document.getElementById('modelSelect').value;
            document.getElementById('customModel').style.display = val === 'å…¶å®ƒ' ? 'block' : 'none';
        }

        // --- Python äº¤äº’ ---
        async function importFile() {
            toggleLoading(true);
            try {
                const mineru_api_key = document.getElementById('MinerU-apiKey').value;
                const content = await window.pywebview.api.open_file(mineru_api_key);
                if (content) {
                    document.getElementById('inputText').value = content;
                    render('input');
                }
            } catch (e) {
                console.log(e);
            } finally {
                setTimeout(() => { toggleLoading(false); }, 800);
            }
        }

        async function exportFile() {
            const content = document.getElementById('outputText').value;
            const msg = await window.pywebview.api.save_file(content);
            alert(msg);
        }

        async function toggleTranslation() {
            const btn = document.getElementById('btnStart');
            const isRunning = btn.innerText === "åœæ­¢ç”Ÿæˆ";

            if (isRunning) {
                await window.pywebview.api.stop_translation();
                btn.innerText = "æ­£åœ¨åœæ­¢...";
                btn.disabled = true;
            } else {
                const content = document.getElementById('inputText').value;
                if (!content.trim()) return alert("è¯·è¾“å…¥éœ€è¦ç¿»è¯‘çš„ Markdown å†…å®¹");

                const apiKey = document.getElementById('apiKey').value;
                let model = document.getElementById('modelSelect').value;
                if (model === 'å…¶å®ƒ') model = document.getElementById('customModel').value;

                const src = document.getElementById('sourceLang').value;
                const tgt = document.getElementById('targetLang').value;

                if (src === tgt) return alert("æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ä¸èƒ½ç›¸åŒ");

                document.getElementById('outputText').value = "";
                render('output');

                setUIState(true);
                window.pywebview.api.start_translation(apiKey, content, model, src, tgt);
            }
        }

        // --- å›è°ƒå‡½æ•° ---
        function onChunkReceived(chunk) {
            const out = document.getElementById('outputText');
            out.value += chunk;
            out.scrollTop = out.scrollHeight;
            render('output');
        }

        function onTranslationFinished() {
            setUIState(false);
        }

        function onTranslationError(err) {
            setUIState(false);
            const out = document.getElementById('outputText');
            out.value += "\n\nâŒ [é”™è¯¯]: " + err;
            render('output');
        }

        function setUIState(running) {
            const btn = document.getElementById('btnStart');
            const ids = ['btnExport', 'btnImport', 'apiKey', 'MinerU-apiKey', 'modelSelect', 'sourceLang', 'targetLang', 'customModel', 'inputText'];

            if (running) {
                btn.innerText = "åœæ­¢ç”Ÿæˆ";
                btn.className = "btn-danger";
                btn.disabled = false;

                document.getElementById('outputText').readOnly = true;

                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.disabled = true;
                    if (el && el.tagName === 'TEXTAREA') el.readOnly = true;
                });
            } else {
                btn.innerText = "å¼€å§‹ç¿»è¯‘";
                btn.className = "btn-primary";
                btn.disabled = false;

                document.getElementById('outputText').readOnly = false;

                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.disabled = false;
                    if (el && el.tagName === 'TEXTAREA') el.readOnly = false;
                });
            }
        }

        // ç›‘å¬ pywebview å‡†å¤‡å°±ç»ªçš„äº‹ä»¶
        window.addEventListener('pywebviewready', async function () {
            try {
                const zhipu_api_key = await window.pywebview.api.get_api_key_frontend('zhipu-api-key');
                // ç¡®ä¿ DOM å…ƒç´ å­˜åœ¨å†èµ‹å€¼ï¼Œé˜²æ­¢æŠ¥é”™
                const zhipuInput = document.getElementById('apiKey');
                if (zhipuInput) zhipuInput.value = zhipu_api_key;
                const mineru_api_key = await window.pywebview.api.get_api_key_frontend('mineru-api-key');
                const mineruInput = document.getElementById('MinerU-apiKey');
                if (mineruInput) mineruInput.value = mineru_api_key;
            } catch (error) {
                console.error("è·å– API Key å¤±è´¥:", error);
            }
        });
    </script>

</body>

</html>